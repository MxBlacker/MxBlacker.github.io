---
date: 2025-09-16
tag: "#嵌入式"
layout: post
title: STM32 - USART串口协议
---
#嵌入式 
# 通信接口
正常我们只能输出高低电平，显然这没办法表示**更复杂的数据**。通信协议制定了通信的规则，通信双方按规则进行数据收发。因为有些功能**STM32**无法完成，所以需要**外挂模块**，这就需要通信了。这也就需要通信规则(通信协议)了。

| 名称    | 引脚                                                                                                         | 双工  | 时钟  | 电平  | 设备  |
| ----- | ---------------------------------------------------------------------------------------------------------- | --- | --- | --- | --- |
| USART | TX (Transmit Exchange)、RX (Receive Exchange)、GND                                                           | 全双工 | 异步  | 单端  | 点对点 |
| I2C   | SCL (Serial Clock)、SDA (Serial Data)、GND                                                                   | 半双工 | 同步  | 单端  | 多设备 |
| SPI   | SCLK (Serial Clock)、MOSI (Master Output Slave Input)、MISO (Master Input Slave Output)、CS (Chip Select)、GND | 全双工 | 同步  | 单端  | 多设备 |
| CAN   | CAN_H、CAN_L                                                                                                | 半双工 | 异步  | 差分  | 多设备 |
| USB   | DP (Data Positive)、DM (Data Minus)                                                                         | 半双工 | 异步  | 差分  | 点对点 |
#### 全双工 / 半双工 / 单工
- **全双工**一般有两条线，一条线负责A->B的数据传输，另一条负责B->A的传输，这也就实现了可以**同时**存在的**双向通信**，我们称为全双工
	- TX发送、RX接受
	- MOSI发送，MISO接受
	- 
> [!attention] 这也就是说通信双方的TX，RX是相互交叉接的 

- **半双工**指的是可以双向通信，但是一次只能一端到另一端
	- SDA负责传输数据
- **单工**指的是单向的数据传输

#### 同步 / 异步
这主要是针对**时钟**而言的
- **同步**指的是接收方可以在时钟信号的引导下进行采样
	- I2C / SPL中的**SCL**线就是时钟线
- **异步**即没有时钟线，需要约定一个频率
	- USART和CAN就是**异步 Asynchronous**的

#### 单端 / 差分
- **单端**指的是双方引脚电平都是对GND的电压差，所以双方必须**共地 (共同一个地)**
- **差分**是靠两个引脚的**电压差**来通讯的，所以不需要共地

#### 点对点 / 多设备
- 顾名思义，就是允许**一对一**和**一对多**

# 串口通信
**串口**是一种应用十分广泛的通讯接口，串口成本低、容易使用、通信线路简单，可实现两个设备的互相通信。单片机的串口可以使**单片机与单片机、单片机与电脑、单片机与各式各样的模块**互相通信，极大地扩展了单片机的应用范围，增强了单片机系统的硬件实力。

#### 电平标准

| 种类           | 高电平         | 低电平        |
| ------------ | ----------- | ---------- |
| TTL          | +3.3V / +5V | 0V         |
| RS232        | -3V ~ -15V  | +3 ~ +15V  |
| RS485 (差分信号) | 两线压差+2~+6   | 两线压差-2~-6V |

#### 串口参数及时序
串口中，**每一个字节**被装载在一个**数据帧**中，由**起始位**，**数据位**和**停止位**，有时会有**校验位**
所以就会有8+2(+1)位，即10(11)位为一帧

- **波特率** (在**二进制调制**中等效为比特率)：串口通信的速率，即读取的速率
- **起始位**：固定为低电平，串口默认为高电平
- **数据位**：**低位先行**

> [!danger] 低位先行
> 假设我要发送的是$0000\ 1111$
> 那么在发送时即发送$1111\ 0000$

- **校验位**：用于数据验证，根据数据位计算得来（奇偶校验），出错概率极低，两位同时出错概率更低，所以可以采用以下的校验方式。
	- 无校验：不需要校验位
	- 奇校验：保证**数据位+校验位**里一共有**奇数个高电平**
	- 偶校验：保证**数据位+校验位**里一共有**偶数个高电平**
- **停止位**：用于数据帧间隔，固定为高电平

# 通用同步 / 异步收发器
**通用同步 / 异步收发器 Universal Synchronous / Asynchronous Receiver / Transmitteer**
**USART**可根据数据寄存器的一个字节数据自动生成数据帧时序，从**TX**引脚发送出去，也可自动接收**RX**引脚的数据帧时序，拼接为一个字节数据，存放在数据寄存器里

- 自带波特率发生器，最高达4.5Mbits/s
- 可配置数据位长度（8/9）、停止位长度（0.5/1/1.5/2）
- 可选校验位（无校验/奇校验/偶校验）
- 支持同步模式、硬件流控制、DMA、智能卡、IrDA、LIN
- STM32F103C8T6 USART资源： USART1(APB2)、 USART2(APB1)、 USART3(APB1)
以上这些直接用**库函数**就能配置

# USART框图

![[STM32 USART框图.png]]

- **TX、RX**是输出，输入引脚，下面三个不用管，我们不用
- **TX**从**发送移位寄存器**发送，**RX**接收到**接受移位寄存器**
- **发送数据寄存器 TDR和接受数据寄存器 RDR**地址一样，但享有不同空间，TDR只写，RDR只读 

	- 在向TDR写入数据后，若**发送移位寄存器**为空，则将寄存器内数据写入，准备发送。TDR会置一个标志位**TXE (TX Empty) 发送寄存器空**，置一即为空，即可写入下一个数据。（类似于双重缓存）
	- **发送移位寄存器**在**发送器控制**的作用下**一位一位**的发送 (向右移位)

	- **接受移位寄存器**接受数据是从高位往低位移动，完成后整体转移到**RDR**。转移过程中置标志位**RXNE (RX Not Empty) 接收数据寄存器非空**，置一即可读走**RDR**的数据

- **硬件数据流控**连着 **nRTS（输出）** 和 **nCTS（输入）**
	- **nRTS**用于告诉其他支持流控的设备**本设备能否接受数据的状态**
	- **nCTS**用于接受别的设备传来的nRTS数据

- **SCLK控制**连着**SCLK**输出口，这样既可以传递**同步信号**了，用来转协议的（SPI）。
- **唤醒单元**支持挂载**多设备**，可以给当前设备分配一个**USART地址**存在**CR2中**，当接收到地址信息后，唤醒单元唤醒设备，即实现多设备互联
- **USART中断控制**用于看**TXE和RXNE**的状态，上面提到过，中断通向**NVIC**

# USART 数据采样
- USART对**一位**进行**16倍**波特率的采样，用于消除噪声和保证准确度
- **波特率发生器**就是搞时钟的，可以接APB2（72MHz）或者APB1（36MHz）的时钟，然后分频
$$波特率={f_{PCLK2/1}\over(16\cdot{DIV})}$$
这里的$f_{PCLK2/1}$是APBx的时钟频率，16就是上文提到的，DIV是分频

 [[STM32 - 5.1 USART数据及数据包的发送，接收与处理]]