---
date: 2025-09-16
tag: "#嵌入式"
layout: post
title: STM32 - 外部中断概述及EXTI中断概述
---
#嵌入式 
# 中断
**中断**指的是CPU暂停当前运行的程序，转而运行中断程序，中断程序运行完毕后再回来运行主程序
中断分为**外部中断**和**内部异常**

实际上，**中断就是异常**，**异常就是中断**，因为他们的处理方式都是传入NVIC然后由CPU决定判断

## 中断优先级
**中断优先级**指的是在有两个中断同时发生时，中断程序的执行顺序，CPU会响应更加紧急的中断源。
这是由==NVIC==进行判断的！
- 中断优先级由**优先级寄存器**的4bit控制，可以切分，分为**响应优先级(Subpriority)** 和 **抢占优先级(Pre-emption Priority)**
- 即，有(0,4) (1,3) (2,2) (3,1) (4,0)五种切分方式
- 每种优先级**取值越小，优先级越高**！
- **响应优先级**仅可以优先排队，它仍需要等待上一个中断程序执行完毕
- **抢占优先级**可以直接插队，就是下面的中断嵌套发生的事
- 如果优先级一样，就按下表的位置顺序来执行

## 中断嵌套
**中断嵌套**指的是当一个中断程序运行时，另一个中断优先级更高的中断源申请中断，转而去处理新的中断源 ( 类比栈 )

## 中断的函数实现
会有一个专门的函数，当中断条件满足时，主函数自动暂停，直接跳转到中断函数，不需要再主函数内调用！

中断条件触发时，外设会给相应的寄存器置一个**标志位**，这个**标志位**通过中断输出控制，到NVIC申请中断

# 中断通道
![[STM32 中断类型表1.png]]
![[STM32 中断类型表2.png]]![[STM32 中断类型表3.png]]![[STM32 中断类型表4.png]]
- 一共有68个可屏蔽中断通道，包括**EXTI，TIM，ADC，USART，SPI，I2C，RTC**等
- **中断通道**也就是中断源，指的是那些可以发送中断请求的设备
- 中断源发送中断请求后传输到**NVIC**，**NVIC**通过优先级来判断应当进行的中断程序

- 图中灰色部分是内核中断，一般用不到
- 白色的就是外设的中断

- 中断地址是用于确定中断函数的地址的，因为编译器在为**中断函数**分配位置的时候是**不确定**的，而**中断条件**满足后需要跳转到**中断函数**，这过程需要**中断函数的地址**。所以我们需要建一个中断跳转表，专门存各种中断函数的地址，这样就能通过访问这个表来跳转到对应的中断函数了。这个表叫**中断向量表**. ( 这里是汇编语言需要这个表，C语言都帮我们搞好了 )

**EXTI0 ~ EXTI4 , EXTI9_5 , EXTI15_10 就是EXTI外部中断了**

> [!attention]
> 这里注意一下，EXTI9_5 , EXTI15_10共用一个中断通道，所以在检测时我们需要额外判断

# NVIC 提供终端控制器
**NVIC ( Nested Vectored Interrupt Controller )**
上面提到了，EXTI有多个中断源，准确来说是16个，即EXTI0~EXTI15
TIM，ADC，USART也有很多....

如果这些同时发送中断信息到NVIC，那么NVIC就会通过优先级排序，把中断程序按照一定顺序给到CPU进行运算

**下面介绍NVIC中可供操作的寄存器**
#### NVIC_ISERx ( Interrupt Set-Enable Registers )
中断设置使能寄存器

#### NVIC_ICERx ( Interrupt Clear-Enable Registers )
中断清除使能寄存器

#### NVIC_ISPRx ( Interrupt Set-Pending Registers )
中断设置挂起寄存器

#### NVIC_ICPRx ( Interrupt Clear-Pending Registers )
中断清除挂起寄存器

#### NVIC_IABRx ( Interrupt Active Bit Registers )
中断活动为寄存器

#### NVIC_IPRx ( Interrupt Priority Registers )
中断优先级寄存器，就是用来设置每个中断的优先级的
但是我们不直接用寄存器来配置优先级，我们用**库函数**

#### NVIC_STIR ( Software Trigger Interrupt Register )
软件触发中断寄存器

### SCB_AIRCR ( Application and Reset Control Register )
这个不是NVIC的，但是是由它来调整优先级切片的
由这个寄存器的8~10位来调整模式

# EXTI 外部中断
进入正题！
**EXTI ( Extern Interrupt ) 外部中断**
这种中断源检测的是**GPIO口的电平信号**，可以检测
1. 上升沿
2. 下降沿
3. 双边沿（上升沿+下降沿）
4. 软件触发 ( 程序里执行代码即可 )
EXTI支持所有GPIO口，但**不行的是PAx和PBx同时触发中断**

EXTI有20个中断线路，包括上面提到的**16个和PVD输出，RTC闹钟，USB唤醒，以太网唤醒**
后四个就是蹭网的，依赖EXTI来完成自身的功能

在检测到中断条件后，有两种触发响应方式
- **中断响应** : 正常的触发中断函数
- **事件响应** : 外部中断的信号不会到NVIC再到CPU，而是通向外部设备，触发其他事件

![[STM32 EXTI框图.png]]

1. 我们从输入线开始看，第一个或门下面的输入是判断**上升沿下降沿**的，上面是判断**软件触发**的
2. 触发后输出高电平，下面是**事件响应**的路，如果读取到**事件屏蔽寄存器**为**屏蔽状态**，则与门下路为0，输出0，即被屏蔽了，否则为1.
3. 请求挂起寄存器将寄存器挂起，准备中断主程序。后面的与门和中断屏蔽寄存器原理同上。信号最后给到NVIC

**下面介绍EXTI中可供操作的寄存器** ( 就是上图那些 )
#### EXTI_IMR ( Interrupt Mask Register )
中断屏蔽寄存器
#### EXTI_EMR ( Event Mask Register )
事件屏蔽寄存器
#### EXTI_RTSR ( Raise Trigger Select Register )
上升沿触发选择寄存器，31-19位保留
18-0 : 
- 0禁止输入线x上升沿触发
- 1允许输入线x上升沿触发
#### EXTI_FTSR ( Fall Trigger Select Register )
下降沿触发选择寄存器，同上
#### EXTI_SWIER ( Software interrupt event register )
软件中断事件寄存器 / 软件触发寄存器
#### EXTI_PR
挂机寄存器


# AFIO 中断引脚选择
EXTI可以链接到PA0~PA15 , PB0~PB15 , PC0~PC15的**48个引脚**，而我们上面说了，**EXTI就只有16个正常输出的引脚**，所以这就需要**AFIO**来进行引脚选择

**AFIO ( Alternate Function I/O ) 中断引脚选择**

PAx , PBx , PCx会从第x个通道送入AFIO选择，在选出一个后再给到EXTI检测是否中断
另外，AFIO还用于**引脚复用功能的选择和重定义**

[[STM32 - 3.1 EXTI的初始化和具体使用]]
[[STM32 - 4 TIM中断概述]]